
@{
    ViewBag.Title = "Chat";
}

<h2 class="alert alert-info">歡樂聊天室</h2>
<title>SignalR 聊天室</title>

<h4 id="userName">你好！ </h4>

<p>聊天室內容</p>
<div id="messageBox">
    <ul id="messageList"></ul>
</div>
<div id="chatList">
    <p><u>在線清單  共<span id="onlineCount"></span>人</u></p>
    <ul id="list"></ul>
</div>
<div id="bar">
    <select id="box">
        <option value="all">所有人</option>
    </select>
    <input type="text" class="message" /> <!--屬性id會讓所有瀏覽器的input有同步的錯覺，因此這裡改成class-->
    <input type="button" id="send" value="發送" />
</div>

@section css{
    <style>
        #userName {
            display: none;
            color: #3465a9;
        }
        #messageBox, #chatList {
            float: left;
            height: 500px;
            width: 70%;
            overflow: auto;
        }
        #messageBox {
            border: 1px solid #808080;
        }
        .message{
            width:100%;
        }
        #chatList {
            border: 1px solid #808080;
            margin:0 0 1% 1% ;
            width: 29%;
            overflow: scroll;
            list-style:circle;
        }
        #list li {
            cursor: pointer;
        }
        #bar {
            clear: both;
        }
        p {
            margin: 0;
        }
    </style>
}

@section scripts {
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>



    <script>
        // ChatObject 聊天功能封裝的物件
        var chatObj = {
            // 在線人數
            onlineCount: 0, 
            // 製作隨機ID
            makeid: function () {
                var text = "";
                var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

                for (var i = 0; i < 5; i++)
                    text += possible.charAt(Math.floor(Math.random() * possible.length));

                return text;
            }
        }


        $(function () {
            var userID = "";//使用者名稱
            userID = window.prompt("請輸入您的大名：");
            if (!userID) // !undefine => true
                userID = "訪客" + chatObj.makeid();

            $("#userName").append(userID).show();


            //建立與Server端的Hub的物件，注意Hub的開頭字母要為小寫 -> C# Class : ChatHub
            var chat = $.connection.chatHub;

            //取得所有上線使用者清單
            chat.client.getList = function (userList) {
                var li = "";
                $.each(userList, function (index, data) {
                    li += "<li id='" + data.id + "'>" + data.name + "</li>";
                    chatObj.onlineCount++;
                });

                $("#list").html(li);
                $("#onlineCount").text(chatObj.onlineCount);
            }

            //新增一筆上線人員
            chat.client.addList = function (id, name) {
                var li = "<li id='" + id + "'>" + name + "</li>";
                $("#list").append(li);

                $("#onlineCount").text(++chatObj.onlineCount);
            }
            //移除一筆上線人員
            chat.client.removeList = function (id) {
                $("#" + id).remove();
                $("#onlineCount").text(--chatObj.onlineCount);
            }







            //--- 建立連線後，我們接著來定義client端的function來讓Server端的hub呼叫。 ---

            //有人初次進聊天室訊息
            chat.client.hello = function (message) {
                $("#messageList").append("<li>" + message + "</li>");
            }

            //全體聊天
            chat.client.sendAll = function (message) {
                $("#messageList").append("<li>" + message + "</li>");
            }



            //密語聊天
            chat.client.sendToSomeOne = function (message) {
                $("#messageList").append("<li>" + message + "</li>");
            }
            //密語聊天 - 自己也要看到傳給別人的訊息
            chat.client.sendToSomeOneMe = function (message) {
                $("#messageList").append("<li>" + message + "</li>");
            }







            //將連線打開
            $.connection.hub.start().done(function () {
                //當連線完成後，呼叫Server端的userConnected方法，並傳送使用者姓名給Server
                chat.server.userConnected(userID);
            });;



            //==== 訊息送出 =====
            $("#send").click(function () {
                var pushMsgInput = $(".message");
                var toId = $("#box").val();
                //判斷是傳給全部人還是密語
                if (toId == "all") {
                    chat.server.send(pushMsgInput.val());//呼叫Server端的send方法，並傳送使用者姓名及訊息內容給Server
                } else {
                    chat.server.sendToSomeOne(toId, pushMsgInput.val());
                }
                pushMsgInput.val('');
            });

            $(".message").keypress(function (event) {  //Enter鍵盤事件註冊
                if (event.which == 13) {
                    $("#send").trigger('click');
                }
            });
            //===================



            //加入密語select
            $("#list").on("click", "li", function () {
                var $this = $(this);
                var id = $this.attr("id");
                var text = $this.text();

                //防止重複加入密語清單
                if ($("#box").has("." + id).length > 0)
                    return false;
                var option = "<option></option>"
                $("#box").append(option).find("option:last").val(id).text(text).attr({ "selected": "selected" }).addClass(id);
            });
        });

    </script>
}